 <!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スポンサー情報まとめ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
  <button id="menu-btn" aria-label="メニューを開く">☰</button>
  <h1>スポンサー情報まとめ</h1>
</header>

<nav id="menu" aria-hidden="true">
  <div id="menu-content">読み込み中…</div>
</nav>

<main id="content">読み込み中…</main>

<script src="parser.js"></script>
<script>
/* =========================
   メニュー制御
========================= */
const btn = document.getElementById('menu-btn');
const menu = document.getElementById('menu');

btn.addEventListener('click', e => {
  e.stopPropagation();
  menu.classList.toggle('open');
  menu.setAttribute('aria-hidden', !menu.classList.contains('open'));
});

menu.addEventListener('click', e => {
  if (e.target.tagName === 'A') {
    menu.classList.remove('open');
    menu.setAttribute('aria-hidden', 'true');
  }
});

document.addEventListener('click', e => {
  if (menu.classList.contains('open') &&
      !menu.contains(e.target) &&
      e.target !== btn) {
    menu.classList.remove('open');
    menu.setAttribute('aria-hidden', 'true');
  }
});

/* =========================
   メニュー読み込み
========================= */
loadMenu();

async function loadMenu() {
  const res = await fetch('pages/menu.txt');
  const text = await res.text();
  document.getElementById('menu-content').innerHTML = parse(text);
  markMissingLinks();
}

/* =========================
   ページ読み込み
========================= */
const params = new URLSearchParams(location.search);
const page = params.get('page') || 'top';
loadPage(`pages/${page}.txt`);

async function loadPage(path) {
  const res = await fetch(path);
  if (!res.ok) {
    showEditor(path);
    return;
  }

  const text = await res.text();
  document.getElementById('content').innerHTML = parse(text);
  markMissingLinks();
}

/* =========================
   未作成ページを赤く
========================= */
async function markMissingLinks() {
  const links = document.querySelectorAll('a[data-page]');
  for (const link of links) {
    const name = link.dataset.page;
    try {
      const res = await fetch(`pages/${name}.txt`);
      if (!res.ok) link.classList.add('missing');
    } catch {
      link.classList.add('missing');
    }
  }
}

/* =========================
   編集モード（③＋④統合）
========================= */
function showEditor(path) {
  const title = decodeURIComponent(
    path.replace('pages/', '').replace('.txt', '')
  );

  document.getElementById('content').innerHTML = `
    <h2>${title}</h2>
    <p>この記事はまだ作成されていません。</p>

    <textarea id="editor" rows="14"
      style="width:100%; box-sizing:border-box;"></textarea>

    <div style="margin:8px 0;">
      <button id="preview-btn">プレビュー</button>
      <button id="publish-btn">公開する</button>
    </div>

    <div id="preview"></div>
  `;

  document.getElementById('preview-btn').onclick = () => {
    const text = document.getElementById('editor').value;
    document.getElementById('preview').innerHTML = `
      <h3>プレビュー</h3>
      ${parse(text)}
    `;
  };

  document.getElementById('publish-btn').onclick = () => {
    const text = document.getElementById('editor').value;
    navigator.clipboard.writeText(text);
    alert(
      `以下の内容を\npages/${title}.txt\nとしてGitHubに保存してください`
    );
  };
}
</script>

</body>
</html>